# -----------------------------------------------------------------------------
# 1) Базовый образ с Python 3.11
# -----------------------------------------------------------------------------
FROM python:3.11-slim

# -----------------------------------------------------------------------------
# 2) Переключаемся в рабочую директорию /app внутри контейнера
# -----------------------------------------------------------------------------
WORKDIR /app

# -----------------------------------------------------------------------------
# 3) Копируем файл с зависимостями и устанавливаем их
# -----------------------------------------------------------------------------
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# -----------------------------------------------------------------------------
# 4) Копируем код бота и шаблон menu.json внутрь образа
#
#    - /app/bot.py   — основной скрипт бота
#    - /app/menu.json — ваш готовый menu.json (будет использоваться как шаблон)
# -----------------------------------------------------------------------------
COPY bot.py      /app/bot.py
COPY data/menu.json   /app/menu.json

# -----------------------------------------------------------------------------
# 5) ENTRYPOINT: при старте контейнера проверяем, есть ли в /data/menu.json;
#    если его нет — копируем из /app/menu.json. После этого запускаем бота.
#
#    Railway автоматически монтирует /data как персистентный том, так что
#    всё, что бот запишет в /data/menu.json, сохранится между деплоями.
# -----------------------------------------------------------------------------
ENTRYPOINT [ "sh", "-c", "\
    if [ ! -f /data/menu.json ]; then \
      cp /app/menu.json /data/menu.json; \
    fi && \
    python /app/bot.py" ]
