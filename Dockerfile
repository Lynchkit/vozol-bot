# -----------------------------------------------------------------------------
# 1) Базовый образ с Python 3.11
# -----------------------------------------------------------------------------
FROM python:3.11-slim

# -----------------------------------------------------------------------------
# 2) Переходим в рабочую папку /app внутри контейнера
# -----------------------------------------------------------------------------
WORKDIR /app

# -----------------------------------------------------------------------------
# 3) Копируем зависимости и устанавливаем их
# -----------------------------------------------------------------------------
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# -----------------------------------------------------------------------------
# 4) Копируем сам код бота и шаблон menu.json
#
#    - /app/bot.py              — основной скрипт
#    - /app/_menu_template.json — шаблон меню, который будет скопирован в /data при первом запуске
# -----------------------------------------------------------------------------
COPY bot.py               /app/bot.py
COPY menu.json            /app/_menu_template.json

# -----------------------------------------------------------------------------
# 5) При старте контейнера:
#      • проверяем, существует ли /data/menu.json
#        – если нет → копируем туда шаблон из /app/_menu_template.json
#      • затем запускаем бота (python /app/bot.py)
#
#   Заметьте: директива VOLUME не используется, поскольку Railway сам монтирует /data
# -----------------------------------------------------------------------------
ENTRYPOINT [ "sh", "-c", "\
    if [ ! -f /data/menu.json ]; then \
      cp /app/_menu_template.json /data/menu.json; \
    fi && \
    python /app/bot.py" ]
