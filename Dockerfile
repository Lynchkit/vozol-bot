# -----------------------------------------------------------------------------
# 1) Базовый образ с Python 3.11
# -----------------------------------------------------------------------------
FROM python:3.11-slim

# -----------------------------------------------------------------------------
# 2) Рабочая директория /app
# -----------------------------------------------------------------------------
WORKDIR /app

# -----------------------------------------------------------------------------
# 3) Копируем requirements и ставим зависимости
# -----------------------------------------------------------------------------
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# -----------------------------------------------------------------------------
# 4) Копируем код бота плюс (опциональные) шаблоны JSON
#
#    Если в репозитории есть menu.json / languages.json — они попадут в /app/
#    Если их нет, просто пропустится копирование, но ENTRYPOINT их создаст.
# -----------------------------------------------------------------------------
COPY bot.py            /app/bot.py
# Если у вас есть готовый шаблон menu.json, раскомментируйте следующую строку:
# COPY menu.json      /app/menu.json
# Если у вас есть готовый шаблон languages.json, раскомментируйте эту:
# COPY languages.json /app/languages.json

# -----------------------------------------------------------------------------
# 5) ENTRYPOINT: создаём /data, инициализируем файл menu.json и languages.json
#    (копируем из /app, если там есть, иначе создаём пустой "{}"), затем запускаем bot.py
# -----------------------------------------------------------------------------
ENTRYPOINT [ "sh", "-c", "\
    mkdir -p /data && \
    if [ ! -f /data/menu.json ]; then \
      if [ -f /app/menu.json ]; then \
        cp /app/menu.json /data/menu.json; \
      else \
        echo '{}' > /data/menu.json; \
      fi; \
    fi && \
    if [ ! -f /data/languages.json ]; then \
      if [ -f /app/languages.json ]; then \
        cp /app/languages.json /data/languages.json; \
      else \
        echo '{}' > /data/languages.json; \
      fi; \
    fi && \
    python /app/bot.py" ]
